name: Sync Registration Page to GitHub Pages

on:
  push:
    branches:
      - main  # Trigger on push to main branch
  workflow_dispatch:  # Allow manual trigger
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight UTC

jobs:
  sync-registration:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Prevent hanging
    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Install Puppeteer and axios
      - name: Install dependencies
        run: npm install puppeteer@24.15.0 axios@1.7.7
        timeout-minutes: 3

      # Scrape the registration page and download assets
      - name: Scrape registration page and assets
        run: |
          mkdir -p dist
          node -e "$(cat << 'EOF'
            const puppeteer = require('puppeteer');
            const axios = require('axios');
            const fs = require('fs').promises;
            const path = require('path');
            (async () => {
              try {
                const browser = await puppeteer.launch({ headless: 'new', args: ['--no-sandbox', '--disable-setuid-sandbox'] });
                const page = await browser.newPage();
                // Set viewport to simulate desktop
                await page.setViewport({ width: 1280, height: 800 });
                // Intercept network requests to capture additional assets
                await page.setRequestInterception(true);
                const additionalAssets = [];
                page.on('request', request => {
                  const url = request.url();
                  if (url.startsWith('https://ctxyouth.com/') && !url.includes('/feed/') && !url.includes('/wp-json/')) {
                    additionalAssets.push(url.split('?')[0]);
                  }
                  request.continue();
                });
                // Load page and wait for dynamic content
                await page.goto('https://ctxyouth.com/registration', { waitUntil: 'networkidle2', timeout: 60000 });
                await new Promise(resolve => setTimeout(resolve, 5000)); // Wait 5s for dynamic content
                
                // Get HTML
                let content = await page.content();
                
                // Extract asset URLs from DOM
                const domAssets = await page.evaluate(() => {
                  const urls = [];
                  const selectors = [
                    'link[href]',
                    'script[src]',
                    'img[src]',
                    'img[srcset]',
                    'source[src]',
                    'source[srcset]',
                    'font[src]',
                    '*[data-src]',
                    '*[data-lazy-src]',
                    'style'
                  ];
                  selectors.forEach(sel => {
                    document.querySelectorAll(sel).forEach(el => {
                      const url = el.href || el.src || el.srcset || el.dataset.src || el.dataset.lazySrc;
                      if (url && url.startsWith('https://ctxyouth.com/') && !url.includes('/feed/') && !url.includes('/wp-json/')) {
                        urls.push(url.split('?')[0]);
                      }
                    });
                  });
                  // Extract CSS background images
                  const styles = Array.from(document.querySelectorAll('style, [style]'));
                  styles.forEach(el => {
                    const styleText = el.innerText || el.getAttribute('style') || '';
                    const matches = styleText.match(/url\(['"]?(https:\/\/ctxyouth\.com\/[^)'"]+)['"]?\)/g);
                    if (matches) {
                      matches.forEach(match => {
                        const urlMatch = match.match(/https:\/\/ctxyouth\.com\/[^)'"]+/);
                        if (urlMatch) urls.push(urlMatch[0]);
                      });
                    }
                  });
                  return [...new Set(urls)];
                });
                
                // Combine DOM and network assets
                const assets = [...new Set([...domAssets, ...additionalAssets])];
                console.log('Assets to download:', assets);
                
                // Download assets and rewrite URLs
                for (const assetUrl of assets) {
                  try {
                    const relativePath = assetUrl.replace('https://ctxyouth.com/', '').split('?')[0];
                    const filePath = path.join('dist', relativePath);
                    console.log('Downloading:', assetUrl, 'to', relativePath);
                    await fs.mkdir(path.dirname(filePath), { recursive: true });
                    const response = await axios.get(assetUrl, { responseType: 'arraybuffer', timeout: 10000 });
                    await fs.writeFile(filePath, response.data);
                    console.log('Downloaded:', relativePath);
                    // Rewrite this specific asset URL in HTML
                    const escapedUrl = assetUrl.replace(/[.*+?^${}()|[\]\\]/g, '\\\\$&');
                    content = content.replace(new RegExp(escapedUrl.split('?')[0], 'g'), `/${relativePath}`);
                  } catch (err) {
                    console.error('Failed to download:', assetUrl, err.message);
                  }
                }
                
                // Rewrite base URL in HTML for non-navigation attributes (exclude <a href>)
                content = content.replace(/(src|srcset|data-src|data-lazy-src)="https:\/\/ctxyouth\.com\/([^"]*)"/g, '$1="/$2"');
                
                // Save HTML to dist root
                await fs.writeFile('dist/index.html', content);
                
                // Debug: List dist contents
                const files = await fs.readdir('dist', { recursive: true });
                console.log('Dist contents:', files);
                await browser.close();
                console.log('Successfully scraped registration page and saved HTML with assets');
              } catch (error) {
                console.error('Error scraping registration page:', error);
                process.exit(1);
              }
            })();
          EOF
          )"
        timeout-minutes: 5

      # Add CNAME file for custom domain
      - name: Add CNAME file
        run: echo "registration.ctxyouth.com" > dist/CNAME

      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: dist
