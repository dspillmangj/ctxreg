name: Sync Registration Page to GitHub Pages

on:
  push:
    branches:
      - main  # Trigger on push to main branch
  workflow_dispatch:  # Allow manual trigger
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight UTC

jobs:
  sync-registration:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Prevent hanging
    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'  # Cache npm dependencies

      # Create package.json and package-lock.json
      - name: Initialize package.json
        run: |
          echo '{
            "name": "ctxreg-sync",
            "version": "1.0.0",
            "private": true,
            "dependencies": {
              "puppeteer": "24.15.0",
              "website-scraper": "5.0.0",
              "website-scraper-puppeteer": "2.0.2"
            }
          }' > package.json
          npm install  # Generate package-lock.json

      # Scrape the registration page with assets
      - name: Scrape registration page
        run: |
          mkdir -p dist
          node -e "
          const scrape = require('website-scraper');
          const PuppeteerPlugin = require('website-scraper-puppeteer');
          (async () => {
            try {
              await scrape({
                urls: ['https://ctxyouth.com/registration'],
                directory: 'dist',
                plugins: [new PuppeteerPlugin({
                  launchOptions: { headless: 'new', args: ['--no-sandbox', '--disable-setuid-sandbox'] },
                  scrollToBottom: { timeout: 10000, viewportN: 10 },
                  blockNavigation: true
                })],
                recursive: true,
                maxDepth: 1,
                filenameGenerator: 'bySiteStructure',
                subdirectories: [
                  { directory: 'img', extensions: ['.jpg', '.png', '.svg', '.gif', '.webp'] },
                  { directory: 'js', extensions: ['.js'] },
                  { directory: 'css', extensions: ['.css'] },
                  { directory: 'fonts', extensions: ['.woff', '.woff2', '.ttf', '.eot'] }
                ],
                request: {
                  headers: { 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36' }
                }
              });
              console.log('Successfully scraped page and assets');
            } catch (error) {
              console.error('Error scraping page:', error);
              process.exit(1);
            }
          })();
          "
        timeout-minutes: 5  # Limit scrape time

      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: actions/setup-node@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: dist
          destination_dir: .
          keep_files: false  # Overwrite existing files
          commit_message: Sync ctxyouth.com/registration with assets to index.html
