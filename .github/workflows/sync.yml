name: Sync Registration HTML
on:
  schedule:
    - cron: '0 * * * *'  # Run hourly
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync-registration:
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Install Puppeteer
      - name: Install Puppeteer
        run: npm install puppeteer

      # Fetch the registration page content using Puppeteer
      - name: Fetch registration page
        run: |
          mkdir -p dist
          node -e "
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          (async () => {
            try {
              const browser = await puppeteer.launch({ headless: true, args: ['--no-sandbox', '--disable-setuid-sandbox'] });
              const page = await browser.newPage();
              await page.goto('https://ctxyouth.com/registration', { waitUntil: 'networkidle2', timeout: 60000 });
              const content = await page.content();
              fs.writeFileSync('dist/index.html', content);
              await browser.close();
              console.log('Successfully fetched and saved page');
            } catch (error) {
              console.error('Error fetching page:', error);
              process.exit(1);
            }
          })();
          "

      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: dist
          destination_dir: .
          keep_files: false  # Overwrite existing files
          commit_message: Sync ctxyouth.com/registration to index.html
